<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./styles.css">
  <title>ETL TERCEROS_CRUD</title>
</head>

<body>
  <div class="container mt-4 position-relative">
    <div class="row justify-content-center d-flex">
      <div class="col-md-6">
        <h1 class="mb-0 pb-0">Generar variables SISE:</h1>
        <span>Opciones para generar variables:</span>
        <span class="text-muted mt-0 pt-0 d-block">- Tienes opci贸n para generar variables basado en un arreglo de strings definido internamente en el c贸digo</span>
        <span class="text-muted mt-0 pt-0 d-block mb-4">- Tienes opci贸n para generar una a una las variables</span>
        <label for="variableName">Ingrese nombre de variable SISE:</label>
        <input class="form-control mb-2" type="text" id="variableName" placeholder="Ingrese nombre de variable">
        <input class="form-control" type="text" id="access_token" placeholder="Ingrese token">

        <div class="row m-3">
          <div class="col-md-6">
            <button type="button" class="btn btn-primary" id="btnSend">Generar variable ingresada</button>
          </div>
          <div class="col-md-6">
            <button type="button" class="btn btn-primary" id="btnSendAllVariables">Generar todas las variables definidas internamente </button>
          </div>
        </div>

        <div class="loader-box d-none" id="loader">
          <div class="loader-08"></div>
        </div>

        <a download="info_complementarias_variables.txt" id="downloadlink" style="display: none">Descargar variables con IDs (DEBEN IR EN LOS ENVIRONMENT DEL SISE)</a>
        <div id="ICsTxts"></div>
      </div>

      <div class="col-md-8 mt-3 pt-3">
        <h2>Listado variables definidas internamente:</h2>
        <div id="variablesArr"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    let variables = [
      // FOTO DE PERFIL
      "Foto de perfil SISE",

      // INFO PERSONAL
      {
        name: "Genero",
        type: 'array'
      },
      "Nacionalidad",
      "Lugar de nacimiento",
      "Estrato",
      "Estado Civil",
      "Tipo de poblacion",
      "Condiciones discapacidad",
      "Correo personal",
      "Red social 1",
      "Red social 2",
      "Codigo del pais",
      "Celular",
      "Pais residencia",
      "Departamento residencia",
      "Municipio residencia",
      "Localidad residencia",
      "Direccion residencia",
      "Intereses",

      // INFO ACADEMICA
      "NOMBRE_COLEGIO",
      "CIUDAD_COLEGIO",
      "FECHA_GRADUACION",
      "Programas de posgrado titulados en la UD",

      // INFO EMPRESARIAL (OPCIONAL)
      "Nombre de su empresa",
      "NIT de la empresa",
      "Sector economico de la empresa",
      "Sitio web de la empresa",
      "Fecha de fundacion de la empresa",
      "Actividades que realiza la empresa",
      "Necesidades profesionales (satisfaccion)",
      "Necesidades economicas (satisfaccion)",
      "Necesidades desarrollo personal (satisfaccion)",
      "Necesidades con su empresa (satisfaccion)",
      "Cantidad de empleados",
      "Cantidad de profesionales o tecnologos empleados",
      "Cantidad de egresados de la UD profesionales o tecnologos empleados",
      "Cantidad de empleos operativos, asistenciales o de apoyo generados",
      // END INFO EMPRESARIAL (OPCIONAL)

      "Principal dificultad a la hora de conseguir trabajo",
      "Canal de busqueda de empleo",
      "PROBLEMTICAS EN DONDE CONSIDERA QUE HA APORTADO",
      "Otra PROBLEMTICA EN DONDE CONSIDERA QUE HA APORTADO",
      "Situacion laboral",
      "Cu谩nto tiempo (en meses) lleva en esta actividad o trabajo?",
      "Ingreso o salario (Satisfaccion laboral)",
      "Cantidad de horas (Satisfaccion laboral)",
      "Aplicacion de conocimientos de la carrera  (Satisfaccion laboral)",
      "Retos y desaf铆os intelectuales (Satisfaccion laboral)",
      "Oportunidades de ascenso (Satisfaccion laboral)",
      "Estabilidad (Satisfaccion laboral)",
      "Ingreso o salario",
      "Razon de vinculacion",
      "Otra razon de vinculacion",
      "Estatus laboral",
      "Actividades que realiza",
      "Tipo de contrato",
      "Sector",
      "Grupo de actividad economica",
      "Formas de trabajo Independientes",
      "Nombre de la empresa en donde labora",
      "Nombre de la empresa",
      "Cuales son los productos o servicios",
      "Ciudad/ municipio / provincia de ubicacion de la empresa",
      "Operacion de la empresa",
      "Etapa en que se encuetra la empresa",
      "En la actualidad, en qu茅 actividad ocupa la mayor parte de su tiempo?",
      "Desea conseguir un trabajo o realizar una actividad remunerada?",
      "Durante el ultimo mes, hizo alguna diligencia para conseguir un trabajo o realizar una actividad remunerada?",
      "Aunque desea trabajar, por qu茅 motivo no hizo diligencias para buscar un trabajo en el ultimo mes?",
      "Si le resultara algun trabajo remunerado Est谩 disponible para empezar a trabajar?",
      "Hace cu谩ntos meses ha estado buscando empleo?",
      "Si desea comentarnos m谩s a detalle acerca de sus aportes, contribuciones o logros, puede hacerlo a continuacion",

      // INFO EMPRENDIMIENTO VARIABLES
      "MOTIVACION_EMPRENDER",
      "DESARROLLADO_PROTOTIPO_MERCADO",
      "TIENE_INTERES_DESARROLLAR_PROTOTIPO",
      "PRODUCTOS_SERVICIOS_PROYECTA_SON",
      "QUE _TANTO_INTERES_CREAR_EMPRESA",
      "CUANTO_TIEMPO_DEDICAR_PROYECTO_NEGOCIO",
      "TIPO_EMPRENDIMIENTO",
      "TECNOLOGIAS_PROYECTO",
      "TECNOLOGIAS_PROYECTO_OTRO",
      "HERRAMIENTAS_RECURSOS_EMPRENDIMIENTO",
      "HERRAMIENTAS_RECURSOS_EMPRENDIMIENTO_OTRO",
      "CUALES_TEMATICAS_ORIENTACION",
      "HA_VENDIDO_PRODUCTO_SERVICIO",
      "QUIEN_VENDIDO_PRODUCTO_SERVICIO",
      "CANALES_EMPLEO_VENDER_PRODUCTO",
      "CANALES_EMPLEO_VENDER_PRODUCTO_OTRO",
      "COMO_OBTUVO_CAPITAL_VENDER",
      "COMO_OBTUVO_CAPITAL_VENDER_OTRO",
      "CONOCE_TRAMITES_PARA_EMPRENDIMIENTO",
      "CONOCE_ASPECTOS_TRIBUTARIOS_PROYECTO",
      "PROCESO_CONTRATACION_CLIENTES_PROVEEDORES",
      "PROCESO_CONTRATACION_EMPLEADOS",
      "RECURSOS_INICIAR_EMPRESA",
      "RECURSOS_INICIAR_EMPRESA_OTRO",
      "ESTRUCTURA_COSTOS_INGRESOS",
      "ASPECTOS_DEFINIDOS_EMPRENDIMIENTO",

      // INFO ESTUDIANTES VARIABLES
      "驴En la actualidad tiene personas a cargo?",
      "Con motivo de su pr贸xima graduaci贸n, 驴Cu谩l es su nivel de expectativa e incertidumbre frente a la obtenci贸n de su t铆tulo?",
      "Que aspectos o competencias le generan inseguridad frente a su perfil profesional",
      "Desea obtener informaci贸n del Seminario de empleabilidad",
      "Seleccione la Facultad de la que es egresado",
      "Seleccione su carrera",
      "Indiqu茅 la fecha programada o estimada de su graduaci贸n",
      "Despu茅s de su graduaci贸n, 驴cu谩l de las siguientes opciones de formaci贸n ha pensado realizar?",
      "驴Tiene conocimiento de los beneficios aplicables en programas de posgrados para egresados?",
      "Seleccione los posgrados de su inter茅s y en los cuales desea obtener informaci贸n",
    ]

    variables.forEach(varia => {

      let variableSTR = typeof varia == 'object' ?
        `<strong>${varia.name}</strong>` :
        varia

      let variableBox = document.createElement("p");

      variableBox.innerHTML = variableSTR

      document.getElementById("variablesArr")
        .appendChild(variableBox)
    })

    let textFile = null,
      makeTextFile = function(text) {
        let data = new Blob([text], {
          type: 'text/plain'
        });

        if (textFile !== null)
          window.URL.revokeObjectURL(textFile);

        textFile = window.URL.createObjectURL(data);

        return textFile;
      };

    let btnSend = document.getElementById("btnSend")
    let btnSendAllVariables = document.getElementById("btnSendAllVariables")
    let baseUrl = "https://autenticacion.portaloas.udistrital.edu.co/apioas/terceros_crud/v1"

    function eliminarVocalesEspecificaLongitud(str, longitudMax = 20) {

      let resultado = str.replace(/[aeiou]/g, '').replace(/ /g, '');
      let countOver = 0;
      let strLength = resultado.length;

      for (let i = 0; i <= strLength; i++) {
        if (i >= longitudMax) countOver++
      }

      if (countOver > 0) resultado = resultado.slice(0, -`${countOver}`)

      return resultado;
    }

    // debugger
    function cortarEspecificaLongitud(str, longitudMax = 20) {
      // debugger
      let resultado = str
      let countOver = 0;
      let strLength = resultado.length;

      for (let i = 0; i <= strLength; i++)
        if (i >= longitudMax) countOver++
      if (countOver > 0) resultado = resultado.slice(0, -`${countOver}`)
      return resultado;
    }

    function showLoader(bool) {
      let loader = document.getElementById("loader")
      let buttons = document.querySelectorAll('button')
      let inputs = document.querySelectorAll('input')

      if (bool) {
        buttons.forEach(button => button.disabled = true)
        inputs.forEach(input => input.disabled = true)

        loader.classList.remove("d-none")
        loader.classList.add("d-block")
      } else {
        buttons.forEach(button => button.disabled = false)
        inputs.forEach(input => input.disabled = false)

        loader.classList.remove("d-block")
        loader.classList.add("d-none")
      }
    }

    function formatVariableStringToEnv(str) {
      return str.replace(/[^\w\s]/gi, '').trim().toUpperCase().split(' ').join('_').toString()
    }

    async function getAPITercerosData(headers) {
      // Obtienes grupo_info_complementarias
      const GICs = await fetch(`${baseUrl}/grupo_info_complementaria?limit=-1`, {
        method: 'GET',
        headers: headers
      });

      const GICsJson = await GICs.json()

      // Obtienes info_complementarias
      const ICs = await fetch(`${baseUrl}/info_complementaria?limit=-1`, {
        method: 'GET',
        headers: headers
      });

      const ICsJson = await ICs.json()

      return {
        GICsJson,
        ICsJson
      }
    }

    // Generar todas las variables
    let objVariablesIDS = {}
    btnSendAllVariables.addEventListener('click', async () => {
      showLoader(true)
      try {
        let access_token = document.getElementById("access_token").value

        if (!access_token || !access_token.trim()) {
          showLoader(false)
          return alert("Ingresa el access_token, puedes extraerlo de una sesi贸n de la app del SISE(sise_cliente). En el localStorage え")
        }

        let headers = {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'authorization': 'Bearer ' + access_token,
        }

        const dataTERCEROS = await getAPITercerosData(headers)

        const GICsJson = dataTERCEROS.GICsJson
        const ICsJson = dataTERCEROS.ICsJson

        btnSendAllVariables.disabled = true

        let variablesIdsStrFull = '';
        let variablesLength = variables.length;

        for (let i = 0; i < variablesLength; i++) {
          console.log(variables[i])
          let variableObjFlag = false
          if (typeof variables[i] == 'object') {
            variableObjFlag = true
          }

          let variableBase = variableObjFlag ?
            variables[i].name :
            variables[i]

          let variableItemName = variableBase ? cortarEspecificaLongitud(variableBase, 98) : ''

          if (!variableItemName) {
            return false;
          }

          let isGICDuplicated = false
          GICsJson.forEach(GIC => {
            if (GIC.Nombre == variableItemName || GIC.Descripcion == variableItemName) {
              isGICDuplicated = true
            }
          })

          if (isGICDuplicated) {
            showLoader(false)
            continue;
          }

          let variableAbbr = eliminarVocalesEspecificaLongitud(variableBase, 20)

          let GICbody = {
            "Id": null,
            "Nombre": variableItemName,
            "Descripcion": variableItemName,
            "CodigoAbreviacion": variableAbbr,
            "Activo": true
          }

          let url = "grupo_info_complementaria"

          // Genera grupo_info_complementaria
          const res = await fetch(`${baseUrl}/${url}`, {
            method: 'POST',
            body: JSON.stringify(GICbody),
            headers: headers
          });

          if (res.status == 401) {
            showLoader(false)
            return alert("access_token invalido, puedes obtener uno del localstorage de la app sise en ejecuci贸n y logueado")
          }

          const data = await res.json();
          console.log(data)
          console.log(data.Id)

          if (!data || !data.Id) {
            showLoader(false)
            console.log('here');

            return console.error('Error al generar el grupo info complementaria de ' + variableItemName)
          }

          if (variableObjFlag) {

            // Genera muchas variables y coloca el arreglo en el objeto que quedar谩 en el txt
            let variableNamesValues = prompt(`Ingresa los valores para ${variableItemName} separados por comas y sin espacios`);

            console.log(typeof variableNamesValues);
            console.log(variableNamesValues);

            if (typeof variableNamesValues != 'string') {
              showLoader(false)
              return console.error('Error al generar el grupo info complementarias de ' + variableItemName);
            }

            variableNamesValues = variableNamesValues.toString().split(',')

            let variableArrIC = []

            for (let i = 0; i <= variableNamesValues.length; i++) {

              let isICDuplicated = false
              ICsJson.forEach(IC => {
                if (IC.Nombre == variableItemName.toUpperCase()) {
                  isICDuplicated = true
                }
              })

              if (isICDuplicated) {
                showLoader(false)
                continue;
              }

              let ICbody = {
                "Activo": true,
                "CodigoAbreviacion": GICbody.CodigoAbreviacion,
                "GrupoInfoComplementariaId": data,
                "Id": null,
                "Nombre": variableItemName.toUpperCase(),
                "TipoDeDato": "string"
              }

              url = "info_complementaria"

              const resIC = await fetch(`${baseUrl}/${url}`, {
                method: 'POST',
                body: JSON.stringify(ICbody),
                headers: headers
              });

              const variableInfoComplementaria = await resIC.json();

              variableArrIC.push(variableInfoComplementaria.Id.toString())
            }

            let newVariableKey = formatVariableStringToEnv(variableItemName)

            // Se llenan con el id de las variables
            variablesIdsStrFull += `\n${newVariableKey.toString()}: [${variableArrIC}],`

            Object.defineProperty(objVariablesIDS, newVariableKey, {
              enumerable: true,
              configurable: true,
              writable: true,
              value: variableArrIC
            });
          } else {
            let isICDuplicated = false
            ICsJson.forEach(IC => {
              if (IC.Nombre == variableItemName.toUpperCase()) {
                isICDuplicated = true
              }
            })

            if (isICDuplicated) {
              showLoader(false)
              continue;
            }
            // Generar variable string
            let ICbody = {
              "Activo": true,
              "CodigoAbreviacion": GICbody.CodigoAbreviacion,
              "GrupoInfoComplementariaId": data,
              "Id": null,
              "Nombre": variableItemName.toUpperCase(),
              "TipoDeDato": "string"
            }

            url = "info_complementaria"

            const resIC = await fetch(`${baseUrl}/${url}`, {
              method: 'POST',
              body: JSON.stringify(ICbody),
              headers: headers
            });

            const data2 = await resIC.json();

            let newVariableKey = formatVariableStringToEnv(variableItemName)
            console.log(newVariableKey)

            // Se llenan con el id de las variables
            variablesIdsStrFull += `\n${newVariableKey.toString()}: ${data2.Id.toString()},`

            Object.defineProperty(objVariablesIDS, newVariableKey, {
              enumerable: true,
              configurable: true,
              writable: true,
              value: data2.Id
            });
          }

        }

        let variablesIdsStr = ``

        for (const keyVariable in objVariablesIDS) {
          console.log(`
          \n${keyVariable}: ${objVariablesIDS[keyVariable]},
          `)

          variablesIdsStr += `${keyVariable}: ${objVariablesIDS[keyVariable]},`
        }

        console.log(variablesIdsStr)
        console.log(variablesIdsStrFull)

        let link = document.getElementById('downloadlink');
        link.href = makeTextFile(`INFO_COMPLEMENTARIA_IDS: {${variablesIdsStrFull}}`);
        link.style.display = 'block';

        document.getElementById('ICsTxts').innerHTML = JSON.stringify(objVariablesIDS)

        btnSendAllVariables.disabled = false

      } catch (e) {
        showLoader(false)
        console.log(e)
      }
      showLoader(false)
    })

    // Generar una variable
    btnSend.addEventListener('click', async () => {
      showLoader(true)

      try {

        let variableName = document.getElementById("variableName").value
        let access_token = document.getElementById("access_token").value

        if (!access_token || !access_token.trim()) {
          showLoader(false)
          return alert("Ingresa el access_token, puedes extraerlo de una sesi贸n de la app del SISE(sise_cliente). En el localStorage え")
        }

        btnSend.disabled = true

        let headers = {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
          'authorization': 'Bearer ' + access_token,
        }

        const dataTERCEROS = await getAPITercerosData(headers)

        const GICsJson = dataTERCEROS.GICsJson
        const ICsJson = dataTERCEROS.ICsJson

        let variableAbbr = eliminarVocalesEspecificaLongitud(variableName, 20)

        console.log(variableAbbr.length)

        let isGICDuplicated = false
        GICsJson.forEach(GIC => {
          if (GIC.Nombre == variableItemName || GIC.Descripcion == variableItemName) {
            isGICDuplicated = true
          }
        })

        if (isGICDuplicated) {
          showLoader(false)
          return alert("Duplicada, ya existe");
        }

        let GICbody = {
          "Id": null,
          "Nombre": variableName,
          "Descripcion": variableName,
          "CodigoAbreviacion": variableAbbr,
          "Activo": true
        }

        let url = "grupo_info_complementaria"

        const res = await fetch(`${baseUrl}/${url}`, {
          method: 'POST',
          body: JSON.stringify(GICbody),
          headers: headers
        })

        if (res.status == 401) {
          showLoader(false)
          return alert("access_token invalido, puedes obtener uno del localstorage de la app sise en ejecuci贸n y logueado")
        }

        const data = await res.json();
        console.log(data)

        if (data && data.Id) {
          let isICDuplicated = false
          ICsJson.forEach(IC => {
            if (IC.Nombre == variableName.toUpperCase()) {
              isICDuplicated = true
            }
          })

          if (isICDuplicated) {
            showLoader(false)
            return alert("Duplicada, ya existe");
          }

          let ICbody = {
            "Activo": true,
            "CodigoAbreviacion": GICbody.CodigoAbreviacion,
            "GrupoInfoComplementariaId": data,
            "Id": null,
            "Nombre": variableName.toUpperCase(),
            "TipoDeDato": "string"
          }

          url = "info_complementaria"

          const res = await fetch(`${baseUrl}/${url}`, {
            method: 'POST',
            body: JSON.stringify(ICbody),
            headers: headers
          });

          const data2 = await res.json();

          console.log(data2)

          let link = document.getElementById('downloadlink');
          let variableKey = variableName.trim().toUpperCase().split(' ').join('_')

          link.href = makeTextFile(`Colocar lo siguiente junto con las variables de entorno del SISE, en caso de que ya este salvar lo anterior en caso de que se pueda necesitar y reemplzar el objeto: \n\nINFO_COMPLEMENTARIA_IDS: {
     ${variableKey}: ${data2.Id} 
     }`);

          link.style.display = 'block';
        }

        btnSend.disabled = false

      } catch (error) {
        showLoader(false)
        console.log('aaa error')
        console.log(error)
      }

      showLoader(false)

    })
  </script>

</body>

</html>